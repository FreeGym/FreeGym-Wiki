# Automation and Contributor Tracking

This document explains how the verification pipeline works end-to-end.
It is intended for maintainers and contributors who want to audit or
extend the system.

---

## Source of Truth

- `contributors.yaml` is the single source of truth for verification.
- `CONTRIBUTORS.md` and `cards/*.svg` are generated outputs.

---

## Workflow Overview

The GitHub Action at `.github/workflows/contributor-tracker.yml` runs
when a PR is merged into `main`.

High-level flow:

1. Collect PR metadata (author, labels, files, commits).
2. Analyze changes to count citations and categorize contributions.
3. Update `contributors.yaml` (new contributor or update existing).
4. Regenerate `CONTRIBUTORS.md`.
5. Regenerate SVG profile cards in `cards/`.

---

## What Gets Tracked

For each contributor, the workflow updates:

- `last_active` (YYYY-MM)
- `topics` (folder names touched)
- `contributions` (per-file entries with type and citations added)
- `total_citations`
- `commits` (low-weight signal; easy to game)
- `prs_merged` and `substantive_prs` (contributors + trusted)
- The card generator marks **ACTIVE** if `last_active` is within 60 days (month-end approximation).

---

## Substantive PRs and Verification

- Maintainers add the `substantive` label to PRs that qualify.
- When a labeled PR is merged, `checkmark: true` is set (if not already).
- The PR number is recorded as `checkmark_pr`.

This keeps the quality decision human while automating the recordkeeping.

---

## Topics (Badges)

Topics are derived from folder names touched by **substantive** PRs.

Current content folders (from the workflow):

- `nutrition`
- `exercise`
- `sleep`
- `mental-health`
- `supplements`
- `recovery`

If new folders are added, update `content_folders` in the workflow.

---

## Citation Counting

Only additions (`+` lines in the diff) are scanned for citations.
The workflow counts matches for:

- PubMed links: `[Study](https://pubmed.ncbi.nlm.nih.gov/12345)`
- DOI links: `[Study](https://doi.org/10.1234/...)`
- PMID references: `PMID: 12345`
- DOI references: `DOI: 10.1234/...`
- Author-year style: `(Smith et al., 2024)`

Patterns live in `.github/workflows/contributor-tracker.yml`.

---

## Contribution Types

Each changed content file is classified as:

- `created` if it appears to be the first commit for that file
- `major_edit` if an edit adds >= 3 citations or >= 20 added lines
- `edit` otherwise

These are heuristic signals, not quality judgments.

---

## Commit Counting

The workflow counts commits in the PR via the GitHub API and adds that
number to the contributor's `commits` total. This metric is low weight
and is displayed with lower prominence.

---

## Generated Outputs

- `CONTRIBUTORS.md` is a readable summary with tables, badges, and card links.
- `cards/*.svg` are shareable profile cards generated by
  `.github/scripts/generate_cards.py`.
- Size variants are emitted as `-square`, `-portrait`, and `-story`.
- Cards are refreshed monthly by `.github/workflows/card-refresh.yml` so the ACTIVE tag stays current.

Only verified contributors (maintainers, trusted, or checkmarked)
receive cards.

---

## Manual Regeneration (Local)

If you need to regenerate outputs locally:

```
python .github/scripts/generate_cards.py
```

`CONTRIBUTORS.md` is generated by the workflow, not a local script.
If you need to regenerate it locally, use the same logic inside the
workflow or trigger the workflow on a test branch.

---

## Where to Adjust Behavior

- Evidence patterns: `.github/workflows/contributor-tracker.yml`
- Topic folders: `.github/workflows/contributor-tracker.yml`
- Card layout: `.github/scripts/generate_cards.py`
- Displayed tables/badges: `.github/workflows/contributor-tracker.yml`
- Schema fields and comments: `contributors.yaml`
